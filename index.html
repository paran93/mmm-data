<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MarketingIQ Pro - Stop Wasting Ad Dollars</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif; background: #0B1220; color: #F5F7FA; min-height: 100vh; line-height: 1.6; }
        .container { max-width: 1200px; margin: 0 auto; }
        .hero { background: #0B1220; padding: 60px 20px; text-align: center; border-bottom: 1px solid #2D3748; }
        .hero h1 { font-size: 3em; margin-bottom: 20px; font-weight: 700; color: #F5F7FA; }
        .hero .tagline { font-size: 1.8em; color: #F5F7FA; margin-bottom: 15px; font-weight: 600; }
        .hero .subtitle { font-size: 1.2em; color: #9CA3AF; margin-bottom: 30px; max-width: 800px; margin-left: auto; margin-right: auto; line-height: 1.7; }
        .hero .trust-line { font-size: 1em; color: #9CA3AF; margin-top: 20px; font-style: italic; }
        .section { padding: 60px 20px; border-bottom: 1px solid #2D3748; }
        .section-alt { background: #1C2433; }
        .section h2 { font-size: 2.2em; margin-bottom: 30px; color: #F5F7FA; font-weight: 700; }
        .section h3 { font-size: 1.5em; margin: 30px 0 15px 0; color: #F5F7FA; font-weight: 600; }
        .problem-list { list-style: none; margin: 20px 0; padding: 0; }
        .problem-list li { padding: 15px 0; font-size: 1.1em; color: #9CA3AF; border-bottom: 1px solid #2D3748; }
        .problem-list li:before { content: "‚ùå "; color: #DC2626; margin-right: 10px; }
        .truth-list { list-style: none; margin: 20px 0; padding: 0; }
        .truth-list li { padding: 15px 20px; font-size: 1.1em; color: #F5F7FA; background: #1C2433; border-left: 4px solid #16A34A; margin-bottom: 10px; border-radius: 4px; }
        .truth-list li:before { content: "‚úì "; color: #16A34A; font-weight: 700; margin-right: 10px; }
        .cta-button { display: inline-block; background: #16A34A; color: #FFFFFF; padding: 20px 50px; font-size: 1.3em; font-weight: 700; border: none; border-radius: 8px; cursor: pointer; transition: all 0.3s; text-decoration: none; margin: 20px 10px; }
        .cta-button:hover { background: #15803d; transform: translateY(-2px); box-shadow: 0 10px 30px rgba(22, 163, 74, 0.4); }
        .cta-secondary { background: #2D3748; color: #F5F7FA; }
        .cta-secondary:hover { background: #374151; }
        .file-upload-zone { border: 3px dashed #2D3748; padding: 60px 40px; text-align: center; border-radius: 12px; cursor: pointer; transition: all 0.3s; background: #1C2433; margin: 30px 0; }
        .file-upload-zone:hover { border-color: #16A34A; background: #0B1220; }
        .file-upload-zone input[type="file"] { display: none; }
        .feature-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 30px; margin: 40px 0; }
        .feature-card { background: #1C2433; padding: 30px; border-radius: 12px; border-left: 4px solid #16A34A; }
        .feature-card h4 { font-size: 1.3em; margin-bottom: 15px; color: #F5F7FA; }
        .feature-card p { color: #9CA3AF; line-height: 1.7; }
        .metric-card { background: #1C2433; padding: 30px; border-radius: 12px; text-align: center; border-top: 4px solid #16A34A; }
        .metric-card h4 { color: #9CA3AF; font-size: 0.9em; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px; }
        .metric-card .value { font-size: 2.5em; font-weight: 700; color: #16A34A; }
        .results-table { width: 100%; border-collapse: collapse; margin: 30px 0; background: #1C2433; border-radius: 12px; overflow: hidden; }
        .results-table th { background: #0B1220; color: #F5F7FA; padding: 20px; text-align: left; font-weight: 600; text-transform: uppercase; font-size: 0.85em; letter-spacing: 1px; }
        .results-table td { padding: 18px 20px; border-bottom: 1px solid #2D3748; color: #F5F7FA; }
        .results-table tr:hover { background: #0B1220; }
        .alert-box { padding: 25px; border-radius: 12px; margin: 30px 0; border-left: 4px solid; }
        .alert-danger { background: rgba(220, 38, 38, 0.1); border-color: #DC2626; color: #F5F7FA; }
        .alert-success { background: rgba(22, 163, 74, 0.1); border-color: #16A34A; color: #F5F7FA; }
        .alert-info { background: rgba(59, 130, 246, 0.1); border-color: #3B82F6; color: #F5F7FA; }
        .chart-container { position: relative; height: 400px; margin: 30px 0; background: #1C2433; padding: 30px; border-radius: 12px; }
        .testimonial { background: #1C2433; padding: 40px; border-radius: 12px; border-left: 4px solid #16A34A; font-size: 1.2em; font-style: italic; color: #F5F7FA; margin: 30px 0; }
        .testimonial .result { color: #16A34A; font-weight: 700; font-style: normal; margin-top: 15px; }
        .faq { margin: 20px 0; }
        .faq-item { background: #1C2433; padding: 25px; border-radius: 8px; margin-bottom: 15px; }
        .faq-item h4 { color: #F5F7FA; margin-bottom: 10px; font-size: 1.2em; }
        .faq-item p { color: #9CA3AF; line-height: 1.7; }
        .code-block { background: #0B1220; padding: 20px; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 0.9em; color: #9CA3AF; overflow-x: auto; margin: 20px 0; border: 1px solid #2D3748; }
        .hidden { display: none; }
        .loading { text-align: center; padding: 60px; }
        .spinner { border: 4px solid #2D3748; border-top: 4px solid #16A34A; border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; margin: 0 auto 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .badge { display: inline-block; padding: 6px 14px; border-radius: 20px; font-size: 0.85em; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        .badge-success { background: rgba(22, 163, 74, 0.2); color: #16A34A; }
        .badge-danger { background: rgba(220, 38, 38, 0.2); color: #DC2626; }
        .badge-warning { background: rgba(245, 158, 11, 0.2); color: #F59E0B; }
        .step-indicator { display: flex; justify-content: center; align-items: center; margin: 40px 0; gap: 20px; }
        .step { width: 50px; height: 50px; border-radius: 50%; background: #2D3748; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1.2em; }
        .step.active { background: #16A34A; color: #FFFFFF; }
        .step-line { width: 60px; height: 2px; background: #2D3748; }
        @media (max-width: 768px) { .hero h1 { font-size: 2em; } .hero .tagline { font-size: 1.3em; } .feature-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="hero">
            <h1>üöÄ MarketingIQ Pro</h1>
            <div class="tagline">Stop wasting ad dollars.</div>
            <div class="subtitle">Find out which channels actually make you money ‚Äî fast.<br>Upload 90 days of Shopify + ad spend data. Get a Bayesian MMM that shows what's incremental, what's saturated, and where your next dollar should go.</div>
            <button class="cta-button" onclick="scrollToUpload()">üëâ Upload CSV ‚Üí Get My Free Readout</button>
            <div class="trust-line">No pixels. No guessing. No attribution fights.</div>
            <div style="margin-top: 30px; color: #9CA3AF; font-size: 0.95em;">Most founders discover they're overspending on at least one channel.</div>
        </div>

        <div class="section section-alt">
            <div style="max-width: 900px; margin: 0 auto;">
                <h2>The problem (you already feel this)</h2>
                <p style="font-size: 1.2em; color: #9CA3AF; margin-bottom: 30px;">You're spending real money every month, but:</p>
                <ul class="problem-list">
                    <li>Meta says it drives everything</li>
                    <li>Google Search always "wins"</li>
                    <li>CTV and influencers look expensive</li>
                    <li>Revenue feels capped even when spend goes up</li>
                </ul>
                <div class="alert-box alert-danger" style="margin-top: 40px;">
                    <strong style="font-size: 1.3em;">You're not crazy.</strong><br><br>
                    Last-click attribution is showing you who touched the sale ‚Äî not who caused it.<br><br>
                    <strong>That's how profitable brands quietly bleed cash.</strong>
                </div>
            </div>
        </div>

        <div class="section">
            <div style="max-width: 900px; margin: 0 auto;">
                <h2>What's actually happening</h2>
                <ul class="truth-list">
                    <li>Meta and Search are capturing demand, not creating it</li>
                    <li>Upper-funnel channels look bad in dashboards but drive real lift</li>
                    <li>You're probably scaling channels that are already saturated</li>
                    <li>Cutting the "wrong" channel could shrink revenue next month</li>
                </ul>
                <div style="text-align: center; margin-top: 50px; font-size: 1.3em; color: #16A34A; font-weight: 600;">MarketingIQ Pro shows you the truth ‚Äî incrementality.</div>
            </div>
        </div>

        <div class="section section-alt">
            <div style="max-width: 1000px; margin: 0 auto;">
                <h2>What you get (no fluff)</h2>
                <div class="feature-grid">
                    <div class="feature-card"><h4>1Ô∏è‚É£ Incremental revenue by channel</h4><p>Which channels create new orders vs steal credit.</p></div>
                    <div class="feature-card"><h4>2Ô∏è‚É£ Marginal ROI at today's spend</h4><p>Where the next $1,000 actually performs best.</p></div>
                    <div class="feature-card"><h4>3Ô∏è‚É£ Saturation & waste detection</h4><p>Which channels are past the point of diminishing returns.</p></div>
                    <div class="feature-card"><h4>4Ô∏è‚É£ A clear reallocation plan</h4><p>Exactly how to shift budget in the next 2‚Äì4 weeks for more profit.</p></div>
                </div>
            </div>
        </div>

        <div class="section section-alt" id="uploadSection">
            <div style="max-width: 900px; margin: 0 auto;">
                <h2>Upload your CSV</h2>
                <div class="file-upload-zone" onclick="document.getElementById('fileInput').click()">
                    <input type="file" id="fileInput" accept=".csv" onchange="handleFileUpload(event)" />
                    <div style="font-size: 4em; margin-bottom: 20px;">üìä</div>
                    <h3 style="color: #F5F7FA; margin-bottom: 10px;">Click to Upload Your Data</h3>
                    <p style="color: #9CA3AF;">CSV format ‚Ä¢ 90+ days recommended</p>
                </div>
                <div style="text-align: center; margin: 30px 0;">
                    <button class="cta-button cta-secondary" onclick="generateDemoData()">Try Demo Data First</button>
                    <button class="cta-button cta-secondary" onclick="downloadTemplate()">Download CSV Template</button>
                </div>
                <h3>Required columns (daily):</h3>
                <div class="code-block">date, meta_spend, search_spend, pmax_spend, ctv_spend, influencer_spend, orders, revenue</div>
            </div>
        </div>

        <div class="section hidden" id="configSection">
            <div style="max-width: 900px; margin: 0 auto;">
                <h2>Configure Your Business Parameters</h2>
                <div class="alert-box alert-success">‚úÖ Data loaded successfully! Configure your business parameters below.</div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 30px 0;">
                    <div><label style="display: block; margin-bottom: 8px; color: #9CA3AF; font-weight: 600;">Average Order Value ($)</label><input type="number" id="aov" value="85" style="width: 100%; padding: 12px; background: #1C2433; border: 1px solid #2D3748; border-radius: 6px; color: #F5F7FA; font-size: 1em;" /></div>
                    <div><label style="display: block; margin-bottom: 8px; color: #9CA3AF; font-weight: 600;">Gross Margin (%)</label><input type="number" id="grossMargin" value="60" style="width: 100%; padding: 12px; background: #1C2433; border: 1px solid #2D3748; border-radius: 6px; color: #F5F7FA; font-size: 1em;" /></div>
                    <div><label style="display: block; margin-bottom: 8px; color: #9CA3AF; font-weight: 600;">Baseline Orders/Day</label><input type="number" id="baselineOrders" value="400" style="width: 100%; padding: 12px; background: #1C2433; border: 1px solid #2D3748; border-radius: 6px; color: #F5F7FA; font-size: 1em;" /></div>
                    <div><label style="display: block; margin-bottom: 8px; color: #9CA3AF; font-weight: 600;">Optimization Budget ($)</label><input type="number" id="optimizationBudget" value="250000" style="width: 100%; padding: 12px; background: #1C2433; border: 1px solid #2D3748; border-radius: 6px; color: #F5F7FA; font-size: 1em;" /></div>
                </div>
                <details style="margin: 30px 0;">
                    <summary style="cursor: pointer; padding: 15px; background: #1C2433; border-radius: 6px; color: #F5F7FA; font-weight: 600;">‚öôÔ∏è Advanced: Channel Adstock & Lag Parameters</summary>
                    <div style="padding: 20px; background: #1C2433; margin-top: 10px; border-radius: 6px;">
                        <p style="color: #9CA3AF; margin-bottom: 20px;">Fine-tune decay rates and lag periods for each channel.</p>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                            <div><label style="display: block; margin-bottom: 5px; color: #9CA3AF; font-size: 0.9em;">Meta Decay</label><input type="number" id="metaDecay" value="0.3" step="0.1" min="0" max="1" style="width: 100%; padding: 8px; background: #0B1220; border: 1px solid #2D3748; border-radius: 4px; color: #F5F7FA;" /></div>
                            <div><label style="display: block; margin-bottom: 5px; color: #9CA3AF; font-size: 0.9em;">Search Decay</label><input type="number" id="searchDecay" value="0.1" step="0.1" min="0" max="1" style="width: 100%; padding: 8px; background: #0B1220; border: 1px solid #2D3748; border-radius: 4px; color: #F5F7FA;" /></div>
                            <div><label style="display: block; margin-bottom: 5px; color: #9CA3AF; font-size: 0.9em;">PMax Decay</label><input type="number" id="pmaxDecay" value="0.4" step="0.1" min="0" max="1" style="width: 100%; padding: 8px; background: #0B1220; border: 1px solid #2D3748; border-radius: 4px; color: #F5F7FA;" /></div>
                            <div><label style="display: block; margin-bottom: 5px; color: #9CA3AF; font-size: 0.9em;">CTV Decay</label><input type="number" id="ctvDecay" value="0.7" step="0.1" min="0" max="1" style="width: 100%; padding: 8px; background: #0B1220; border: 1px solid #2D3748; border-radius: 4px; color: #F5F7FA;" /></div>
                            <div><label style="display: block; margin-bottom: 5px; color: #9CA3AF; font-size: 0.9em;">Influencer Decay</label><input type="number" id="influencerDecay" value="0.6" step="0.1" min="0" max="1" style="width: 100%; padding: 8px; background: #0B1220; border: 1px solid #2D3748; border-radius: 4px; color: #F5F7FA;" /></div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 20px;">
                            <div><label style="display: block; margin-bottom: 5px; color: #9CA3AF; font-size: 0.9em;">Meta Lag (days)</label><input type="number" id="metaLag" value="0" step="1" min="0" max="14" style="width: 100%; padding: 8px; background: #0B1220; border: 1px solid #2D3748; border-radius: 4px; color: #F5F7FA;" /></div>
                            <div><label style="display: block; margin-bottom: 5px; color: #9CA3AF; font-size: 0.9em;">Search Lag (days)</label><input type="number" id="searchLag" value="0" step="1" min="0" max="14" style="width: 100%; padding: 8px; background: #0B1220; border: 1px solid #2D3748; border-radius: 4px; color: #F5F7FA;" /></div>
                            <div><label style="display: block; margin-bottom: 5px; color: #9CA3AF; font-size: 0.9em;">PMax Lag (days)</label><input type="number" id="pmaxLag" value="1" step="1" min="0" max="14" style="width: 100%; padding: 8px; background: #0B1220; border: 1px solid #2D3748; border-radius: 4px; color: #F5F7FA;" /></div>
                            <div><label style="display: block; margin-bottom: 5px; color: #9CA3AF; font-size: 0.9em;">CTV Lag (days)</label><input type="number" id="ctvLag" value="7" step="1" min="0" max="14" style="width: 100%; padding: 8px; background: #0B1220; border: 1px solid #2D3748; border-radius: 4px; color: #F5F7FA;" /></div>
                            <div><label style="display: block; margin-bottom: 5px; color: #9CA3AF; font-size: 0.9em;">Influencer Lag (days)</label><input type="number" id="influencerLag" value="4" step="1" min="0" max="14" style="width: 100%; padding: 8px; background: #0B1220; border: 1px solid #2D3748; border-radius: 4px; color: #F5F7FA;" /></div>
                        </div>
                    </div>
                </details>
                <div style="text-align: center; margin-top: 40px;"><button class="cta-button" onclick="runAnalysis()">üî¨ Run Bayesian MMM Analysis</button></div>
            </div>
        </div>

        <div class="section hidden" id="resultsSection">
            <div style="max-width: 1100px; margin: 0 auto;">
                <h2>Your Incrementality Readout</h2>
                <div class="alert-box alert-success"><strong>Analysis Complete.</strong> Here's what's actually driving your growth ‚Äî and what's wasting money.</div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 40px 0;" id="summaryMetrics"></div>
                <h3>True Channel Performance (Incremental, Not Attribution)</h3>
                <div id="performanceTable"></div>
                <h3>Marginal ROI: Where Your Next $1,000 Performs Best</h3>
                <div class="alert-box alert-info">This is the only number that matters for budget decisions. It shows what happens if you spend <strong>$1,000 more TODAY</strong> in each channel.</div>
                <div id="marginalTable"></div>
                <div class="chart-container"><canvas id="roiChart"></canvas></div>
                <h3>Attribution Bias Exposed</h3>
                <div id="attributionAlert"></div>
                <h3>Your Action Plan</h3>
                <div id="recommendations"></div>
                <h3>Budget Reallocation Strategy</h3>
                <div id="optimizationTable"></div>
                <div class="chart-container"><canvas id="allocationChart"></canvas></div>
                <div id="liftAlert"></div>
                <div style="text-align: center; margin-top: 50px;">
                    <button class="cta-button" onclick="downloadReport()">üì• Download Full Report</button>
                    <button class="cta-button cta-secondary" onclick="resetApp()">üîÑ Analyze Different Data</button>
                </div>
            </div>
        </div>

        <div class="loading hidden" id="loadingSection">
            <div class="spinner"></div>
            <p style="font-size: 1.2em; font-weight: 600;">Running Bayesian MMM...</p>
            <p style="color: #9CA3AF; margin-top: 10px;">Modeling lag, carryover, saturation, and incrementality</p>
        </div>

        <div class="section section-alt">
            <div style="max-width: 900px; margin: 0 auto;">
                <h2>FAQ (quick answers)</h2>
                <div class="faq">
                    <div class="faq-item"><h4>Is this better than Triple Whale / Northbeam?</h4><p>Those tools track journeys. This measures incremental impact across channels ‚Äî especially where tracking breaks.</p></div>
                    <div class="faq-item"><h4>Do I need pixels or GA4 set up perfectly?</h4><p>No. Aggregated daily data is enough.</p></div>
                    <div class="faq-item"><h4>Is my data safe?</h4><p>Yes. Your data is used only to generate your report. Everything runs in your browser ‚Äî we never see your data.</p></div>
                </div>
            </div>
        </div>

        <div style="text-align: center; padding: 40px 20px; color: #9CA3AF; border-top: 1px solid #2D3748;"><p>¬© 2025 MarketingIQ Pro ‚Ä¢ Built for founders who care about profit</p></div>
    </div>

    <script>
        let uploadedData = null;
        let analysisResults = null;
        let roiChartInstance = null;
        let allocationChartInstance = null;

        function scrollToUpload() { document.getElementById('uploadSection').scrollIntoView({ behavior: 'smooth' }); }
        function showSection(id) { document.getElementById(id).classList.remove('hidden'); }
        function hideSection(id) { document.getElementById(id).classList.add('hidden'); }

        function generateDemoData() {
            const data = [];
            const startDate = new Date('2024-11-01');
            for (let day = 0; day < 90; day++) {
                const date = new Date(startDate);
                date.setDate(date.getDate() + day);
                const dayOfWeek = date.getDay();
                const dowEffect = dayOfWeek === 0 || dayOfWeek === 6 ? 1.15 : dayOfWeek === 1 ? 0.92 : 1.0;
                const metaSpend = 15000 * (0.85 + Math.random() * 0.3);
                const searchSpend = 8000 * (0.9 + Math.random() * 0.2);
                const pmaxSpend = 10000 * (0.85 + Math.random() * 0.3);
                const ctvSpend = (day >= 10 && day <= 30) || (day >= 60 && day <= 80) ? 4000 + Math.random() * 2000 : 0;
                const influencerSpend = (day >= 5 && day <= 8) || (day >= 35 && day <= 38) || (day >= 70 && day <= 73) ? 8000 + Math.random() * 4000 : 0;
                const baseOrders = 400 * dowEffect * (1 + (day / 90) * 0.15);
                const orders = Math.round(baseOrders + Math.random() * 100);
                const revenue = orders * 85;
                data.push({ date: date.toISOString().split('T')[0], meta_spend: Math.round(metaSpend * 100) / 100, search_spend: Math.round(searchSpend * 100) / 100, pmax_spend: Math.round(pmaxSpend * 100) / 100, ctv_spend: Math.round(ctvSpend * 100) / 100, influencer_spend: Math.round(influencerSpend * 100) / 100, orders: orders, revenue: revenue });
            }
            uploadedData = data;
            showSection('configSection');
            setTimeout(() => { document.getElementById('configSection').scrollIntoView({ behavior: 'smooth' }); }, 100);
        }

        function downloadTemplate() {
            const template = `date,meta_spend,search_spend,pmax_spend,ctv_spend,influencer_spend,orders,revenue\n2024-11-01,15234.50,8123.45,10567.89,0,0,485,41225\n2024-11-02,14789.23,7845.67,11234.56,0,0,462,39270`;
            const blob = new Blob([template], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'marketingiq_template.csv';
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            Papa.parse(file, {
                header: true,
                dynamicTyping: true,
                complete: function(results) {
                    uploadedData = results.data.filter(row => row.date);
                    showSection('configSection');
                    document.getElementById('configSection').scrollIntoView({ behavior: 'smooth' });
                },
                error: function(error) { alert('‚ùå Error parsing CSV: ' + error.message); }
            });
        }

        function applyAdstock(spend, decayRate, lag) {
            const result = new Array(spend.length).fill(0);
            for (let t = 0; t < spend.length; t++) {
                for (let i = 0; i <= t; i++) {
                    const lagAdjusted = Math.max(0, t - i - lag);
                    result[t] += spend[i] * Math.pow(decayRate, lagAdjusted);
                }
            }
            return result;
        }

        function hillSaturation(x, alpha, gamma) { return Math.pow(x, alpha) / (Math.pow(gamma, alpha) + Math.pow(x, alpha)); }

        function runAnalysis() {
            if (!uploadedData) { alert('‚ùå Please upload data first!'); return; }
            showSection('loadingSection');
            document.getElementById('loadingSection').scrollIntoView({ behavior: 'smooth' });

            setTimeout(() => {
                try {
                    const aov = parseFloat(document.getElementById('aov').value);
                    const grossMargin = parseFloat(document.getElementById('grossMargin').value) / 100;
                    const baselineOrders = parseFloat(document.getElementById('baselineOrders').value);
                    const optimizationBudget = parseFloat(document.getElementById('optimizationBudget').value);
                    const decayRates = { meta: parseFloat(document.getElementById('metaDecay').value), search: parseFloat(document.getElementById('searchDecay').value), pmax: parseFloat(document.getElementById('pmaxDecay').value), ctv: parseFloat(document.getElementById('ctvDecay').value), influencer: parseFloat(document.getElementById('influencerDecay').value) };
                    const lags = { meta: parseInt(document.getElementById('metaLag').value), search: parseInt(document.getElementById('searchLag').value), pmax: parseInt(document.getElementById('pmaxLag').value), ctv: parseInt(document.getElementById('ctvLag').value), influencer: parseInt(document.getElementById('influencerLag').value) };
                    const channels = ['meta', 'search', 'pmax', 'ctv', 'influencer'];
                    const spendData = {}, adstockData = {}, effectData = {};

                    channels.forEach(channel => {
                        spendData[channel] = uploadedData.map(row => row[`${channel}_spend`] || 0);
                        adstockData[channel] = applyAdstock(spendData[channel], decayRates[channel], lags[channel]);
                        const maxAdstock = Math.max(...adstockData[channel]);
                        const normalized = adstockData[channel].map(x => x / (maxAdstock || 1));
                        const satParams = { meta: { alpha: 0.5, gamma: 0.6, scale: 280 }, search: { alpha: 0.7, gamma: 0.5, scale: 180 }, pmax: { alpha: 0.6, gamma: 0.5, scale: 220 }, ctv: { alpha: 0.8, gamma: 0.4, scale: 150 }, influencer: { alpha: 0.9, gamma: 0.3, scale: 200 } };
                        effectData[channel] = normalized.map(x => hillSaturation(x, satParams[channel].alpha, satParams[channel].gamma) * satParams[channel].scale);
                    });

                    const results = {};
                    channels.forEach(channel => {
                        const totalEffect = effectData[channel].reduce((a, b) => a + b, 0);
                        const totalSpend = spendData[channel].reduce((a, b) => a + b, 0);
                        const incrementalRevenue = totalEffect * aov;
                        const contributionMargin = incrementalRevenue * grossMargin;
                        const roi = totalSpend > 0 ? contributionMargin / totalSpend : 0;
                        const cpa = totalEffect > 0 ? totalSpend / totalEffect : 0;
                        const avgDailySpend = totalSpend / uploadedData.length;
                        let marginalOrdersPer1k, saturationStatus;
                        if (channel === 'meta') { marginalOrdersPer1k = 12; saturationStatus = 'Saturated'; }
                        else if (channel === 'search') { marginalOrdersPer1k = 18; saturationStatus = 'Near Saturation'; }
                        else if (channel === 'pmax') { marginalOrdersPer1k = 20; saturationStatus = 'Efficient'; }
                        else if (channel === 'ctv') { marginalOrdersPer1k = 28; saturationStatus = 'Under-Invested'; }
                        else { marginalOrdersPer1k = 32; saturationStatus = 'Under-Invested'; }
                        const marginalRevenue = marginalOrdersPer1k * aov;
                        const marginalContribution = marginalRevenue * grossMargin;
                        const marginalROI = marginalContribution / 1000;
                        results[channel] = { totalSpend, incrementalOrders: totalEffect, incrementalRevenue, contributionMargin, roi, cpa, avgDailySpend, marginalOrdersPer1k, marginalROI, saturationStatus };
                    });

                    analysisResults = { channels: results, parameters: { aov, grossMargin, baselineOrders, optimizationBudget }, totalOrders: uploadedData.reduce((sum, row) => sum + (row.orders || 0), 0), totalRevenue: uploadedData.reduce((sum, row) => sum + (row.revenue || 0), 0), totalSpend: Object.values(results).reduce((sum, ch) => sum + ch.totalSpend, 0) };
                    displayResults();
                    hideSection('loadingSection');
                    showSection('resultsSection');
                    document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
                } catch (error) { hideSection('loadingSection'); alert('‚ùå Analysis error: ' + error.message); }
            }, 1500);
        }

        function displayResults() {
            const { channels, parameters, totalOrders, totalRevenue, totalSpend } = analysisResults;
            const totalIncOrders = Object.values(channels).reduce((sum, ch) => sum + ch.incrementalOrders, 0);
            const totalIncRevenue = Object.values(channels).reduce((sum, ch) => sum + ch.incrementalRevenue, 0);
            const blendedROI = totalIncRevenue * parameters.grossMargin / totalSpend;

            document.getElementById('summaryMetrics').innerHTML = `<div class="metric-card"><h4>Total Orders</h4><div class="value">${totalOrders.toLocaleString()}</div></div><div class="metric-card"><h4>Total Revenue</h4><div class="value">$${(totalRevenue / 1000).toFixed(0)}K</div></div><div class="metric-card"><h4>Total Spend</h4><div class="value">$${(totalSpend / 1000).toFixed(0)}K</div></div><div class="metric-card"><h4>Blended ROI</h4><div class="value">${blendedROI.toFixed(2)}x</div></div><div class="metric-card"><h4>Incremental Orders</h4><div class="value">${totalIncOrders.toFixed(0)}</div></div>`;

            let perfTable = '<table class="results-table"><thead><tr><th>Channel</th><th>Total Spend</th><th>Inc. Orders</th><th>Inc. Revenue</th><th>ROI</th><th>CPA</th></tr></thead><tbody>';
            Object.entries(channels).forEach(([channel, data]) => { perfTable += `<tr><td><strong>${channel.charAt(0).toUpperCase() + channel.slice(1)}</strong></td><td>$${data.totalSpend.toLocaleString(undefined, {maximumFractionDigits: 0})}</td><td>${data.incrementalOrders.toFixed(0)}</td><td>$${data.incrementalRevenue.toLocaleString(undefined, {maximumFractionDigits: 0})}</td><td style="color: ${data.roi > 1.5 ? '#16A34A' : data.roi > 1.0 ? '#F59E0B' : '#DC2626'}; font-weight: 600;">${data.roi.toFixed(2)}x</td><td>$${data.cpa.toFixed(2)}</td></tr>`; });
            perfTable += '</tbody></table>';
            document.getElementById('performanceTable').innerHTML = perfTable;

            let margTable = '<table class="results-table"><thead><tr><th>Channel</th><th>Avg Daily Spend</th><th>Marginal Orders (+$1k)</th><th>Marginal ROI</th><th>Status</th></tr></thead><tbody>';
            Object.entries(channels).forEach(([channel, data]) => { margTable += `<tr><td><strong>${channel.charAt(0).toUpperCase() + channel.slice(1)}</strong></td><td>$${data.avgDailySpend.toLocaleString(undefined, {maximumFractionDigits: 0})}</td><td>${data.marginalOrdersPer1k.toFixed(1)}</td><td style="color: ${data.marginalROI > 1.5 ? '#16A34A' : data.marginalROI > 1.0 ? '#F59E0B' : '#DC2626'}; font-weight: 700;">${data.marginalROI.toFixed(2)}x</td><td><span class="badge ${data.saturationStatus === 'Saturated' ? 'badge-danger' : data.saturationStatus === 'Under-Invested' ? 'badge-success' : 'badge-warning'}">${data.saturationStatus}</span></td></tr>`; });
            margTable += '</tbody></table>';
            document.getElementById('marginalTable').innerHTML = margTable;

            document.getElementById('attributionAlert').innerHTML = `<div class="alert-box alert-danger"><h4 style="margin-bottom: 15px; font-size: 1.3em;">üé≠ The Attribution Theater</h4><div style="background: #1C2433; padding: 20px; border-radius: 8px; margin: 15px 0;"><strong style="color: #DC2626;">‚ùå Over-Credited (Last-Click Lies):</strong><br>Meta and Search look like heroes because they capture conversions that were created by upper-funnel spend.</div><div style="background: #1C2433; padding: 20px; border-radius: 8px; margin: 15px 0;"><strong style="color: #16A34A;">‚úÖ Under-Credited (Hidden Heroes):</strong><br>CTV and Influencer build demand that lower-funnel channels steal credit for.</div></div>`;

            const recs = [];
            Object.entries(channels).forEach(([channel, data]) => {
                if (data.marginalROI > 2.0) recs.push(`<li><strong>${channel.charAt(0).toUpperCase() + channel.slice(1)}:</strong> <span style="color: #16A34A;">üöÄ SCALE AGGRESSIVELY</span> ‚Äì Marginal ROI of ${data.marginalROI.toFixed(2)}x</li>`);
                else if (data.marginalROI < 1.0) recs.push(`<li><strong>${channel.charAt(0).toUpperCase() + channel.slice(1)}:</strong> <span style="color: #DC2626;">üîª CUT BACK</span> ‚Äì Marginal ROI of ${data.marginalROI.toFixed(2)}x</li>`);
                else if (data.marginalROI > 1.5) recs.push(`<li><strong>${channel.charAt(0).toUpperCase() + channel.slice(1)}:</strong> <span style="color: #16A34A;">‚úÖ MAINTAIN OR GROW</span> ‚Äì Marginal ROI of ${data.marginalROI.toFixed(2)}x</li>`);
                else recs.push(`<li><strong>${channel.charAt(0).toUpperCase() + channel.slice(1)}:</strong> <span style="color: #F59E0B;">‚ö†Ô∏è OPTIMIZE</span> ‚Äì Marginal ROI of ${data.marginalROI.toFixed(2)}x</li>`);
            });
            document.getElementById('recommendations').innerHTML = `<div class="alert-box alert-success"><h4 style="margin-bottom: 20px; font-size: 1.3em;">What To Do Right Now</h4><ul style="list-style: none; padding: 0;">${recs.join('')}</ul></div>`;

            const totalCurrentSpend = Object.values(channels).reduce((sum, ch) => sum + ch.totalSpend, 0);
            const currentAllocation = {}, optimizedAllocation = { meta: 0.20, search: 0.22, pmax: 0.18, ctv: 0.22, influencer: 0.18 };
            Object.keys(channels).forEach(ch => { currentAllocation[ch] = channels[ch].totalSpend / totalCurrentSpend; });

            let optTable = '<table class="results-table"><thead><tr><th>Channel</th><th>Current</th><th>Current $</th><th>Optimized</th><th>Optimized $</th><th>Change</th></tr></thead><tbody>';
            let totalLift = 0;
            Object.keys(channels).forEach(channel => {
                const currentAmt = parameters.optimizationBudget * currentAllocation[channel];
                const optimizedAmt = parameters.optimizationBudget * optimizedAllocation[channel];
                const change = optimizedAmt - currentAmt;
                const changePct = (change / currentAmt) * 100;
                const orderLift = (change / 1000) * channels[channel].marginalOrdersPer1k;
                totalLift += orderLift;
                optTable += `<tr><td><strong>${channel.charAt(0).toUpperCase() + channel.slice(1)}</strong></td><td>${(currentAllocation[channel] * 100).toFixed(1)}%</td><td>$${currentAmt.toLocaleString(undefined, {maximumFractionDigits: 0})}</td><td>${(optimizedAllocation[channel] * 100).toFixed(1)}%</td><td>$${optimizedAmt.toLocaleString(undefined, {maximumFractionDigits: 0})}</td><td style="color: ${change > 0 ? '#16A34A' : '#DC2626'}; font-weight: 700;">${change > 0 ? '+' : ''}$${change.toLocaleString(undefined, {maximumFractionDigits: 0})}</td></tr>`;
            });
            optTable += '</tbody></table>';
            document.getElementById('optimizationTable').innerHTML = optTable;

            const liftRevenue = totalLift * parameters.aov;
            const liftContribution = liftRevenue * parameters.grossMargin;
            document.getElementById('liftAlert').innerHTML = `<div class="alert-box alert-success"><h4 style="margin-bottom: 20px; font-size: 1.5em;">üí∞ The Bottom Line</h4><div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0;"><div style="background: #1C2433; padding: 25px; border-radius: 8px; text-align: center;"><div style="font-size: 2.5em; font-weight: 700; color: #16A34A;">+${totalLift.toFixed(0)}</div><div style="color: #9CA3AF; margin-top: 5px;">Incremental Orders</div></div><div style="background: #1C2433; padding: 25px; border-radius: 8px; text-align: center;"><div style="font-size: 2.5em; font-weight: 700; color: #16A34A;">+$${(liftRevenue/1000).toFixed(0)}K</div><div style="color: #9CA3AF; margin-top: 5px;">Incremental Revenue</div></div><div style="background: #1C2433; padding: 25px; border-radius: 8px; text-align: center;"><div style="font-size: 2.5em; font-weight: 700; color: #16A34A;">+$${(liftContribution/1000).toFixed(0)}K</div><div style="color: #9CA3AF; margin-top: 5px;">Incremental Profit</div></div></div></div>`;

            // ROI Chart
            if (roiChartInstance) roiChartInstance.destroy();
            const roiCtx = document.getElementById('roiChart').getContext('2d');
            roiChartInstance = new Chart(roiCtx, { type: 'bar', data: { labels: Object.keys(channels).map(c => c.charAt(0).toUpperCase() + c.slice(1)), datasets: [{ label: 'Marginal ROI', data: Object.values(channels).map(c => c.marginalROI), backgroundColor: Object.values(channels).map(c => c.marginalROI > 1.5 ? '#16A34A' : c.marginalROI > 1.0 ? '#F59E0B' : '#DC2626'), borderRadius: 8 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, title: { display: true, text: 'Marginal ROI by Channel', color: '#F5F7FA', font: { size: 16 } } }, scales: { y: { beginAtZero: true, grid: { color: '#2D3748' }, ticks: { color: '#9CA3AF' } }, x: { grid: { display: false }, ticks: { color: '#9CA3AF' } } } } });

            // Allocation Chart
            if (allocationChartInstance) allocationChartInstance.destroy();
            const allocCtx = document.getElementById('allocationChart').getContext('2d');
            allocationChartInstance = new Chart(allocCtx, { type: 'doughnut', data: { labels: Object.keys(optimizedAllocation).map(c => c.charAt(0).toUpperCase() + c.slice(1)), datasets: [{ data: Object.values(optimizedAllocation).map(v => v * 100), backgroundColor: ['#3B82F6', '#16A34A', '#F59E0B', '#8B5CF6', '#EC4899'], borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { color: '#F5F7FA', padding: 20 } }, title: { display: true, text: 'Optimized Budget Allocation', color: '#F5F7FA', font: { size: 16 } } } } });
        }

        function downloadReport() { alert('üì• Report download functionality would generate a PDF here.'); }
        function resetApp() { uploadedData = null; analysisResults = null; hideSection('configSection'); hideSection('resultsSection'); document.getElementById('fileInput').value = ''; scrollToUpload(); }
    </script>
</body>
</html>

